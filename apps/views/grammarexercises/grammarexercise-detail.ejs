<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= exercise.title %></title>
    <!-- Bootstrap v√† jQuery -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <link rel="icon" href="/static/images/favicon2.png">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <!-- Animate CSS -->
    <link rel="stylesheet" href="/static/css/animate.css">
    <!-- Owl Carousel CSS -->
    <link rel="stylesheet" href="/static/css/owl.carousel.min.css">
    <!-- Themify Icons -->
    <link rel="stylesheet" href="/static/css/themify-icons.css">
    <!-- Flaticon CSS -->
    <link rel="stylesheet" href="/static/css/flaticon.css">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="/static/css/magnific-popup.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <!-- Swiper CSS -->
    <link rel="stylesheet" href="/static/css/slick.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        .exercises-container {
            margin: 105px auto 30px auto;
            max-width: 800px;
            min-width: 300px;
            padding: 25px;
            box-shadow: 0 5px 5px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            background-color: #fff;
        }

        @media (max-width: 768px) {
            .exercises-container {
                width: 80%;
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .exercises-container {
                width: 95%;
                padding: 10px;
            }
        }
        .form-check {
            padding-left: 0;
        }
        .form-check-label {
            display: block;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
            background-color: #fff;
        }
        .form-check-input {
            display: none;
        }
        .form-check-input:checked + .form-check-label {
            border-color: rgb(82, 82, 166);
            font-weight: bold;
        }
        .disabled {
            pointer-events: none;
            opacity: 0.6;
        }
        .explanation {
            border: 1px solid cadetblue;
            line-height: 1.8;
            padding: 10px;
            font-size: 15px;
            font-weight: bold;
        }
        .correct-answer {
            background-color: #aceebb !important;
            font-weight: bold !important;
        }
        .incorrect-answer {
            background-color: #eab3b8 !important;
            font-weight: bold !important;
        }
        .btn {
            width: 100%;
        }
        .result-content {
            text-align: center;
        }
        .result-content p{
            margin: 20px 0;
            color: black;
            font-size: 16px;
        }
        .result-number {
            font-weight: bold;
            color: black;
            font-size: 16px;
        }
        .result-percentage {
            font-size: 16px;
            color: #17a2b8;
        }
        .result-icon {
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .result-icon img {
            width: 200px;
            height: auto;
        }

        /* Ph·∫ßn b√™n ph·∫£i - th·ªùi gian v√† danh s√°ch c√¢u h·ªèi */
        .sidebar {
            margin: 105px auto 30px auto;
            padding: 25px;
            box-shadow: 0 5px 5px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            background-color: #fff;
        }

        .time-remaining {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .question-list {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .question-list button {
            background-color: #fff;
            color: #333;
            border: 1px solid black;
            padding: 5px;
            font-size: 13px;
            border-radius: 4px;
            cursor: pointer;
        }
        .question-list button.active {
            background-color: #6c757d;
        }

        .question-list button:hover {
            background-color: #0057b3;
            color: white;
        }
        .submit-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            width: 100%;
        }
        .history-item {
            margin-bottom: 20px;
        }
        .history-item h5 {
            font-size: 18px;
            font-weight: bold;
        }
        .history-item p {
            font-size: 16px;
            margin: 5px 0;
        }
        .speak-button {
            border: 1px solid #9ba0a6;
            background-color: #ffffff;
        }

    </style>
</head>
<body>
    <%- include('../partials/menu.ejs') %>
    <div class="container">
        <div class="row">
            <!-- C·ªôt b√™n tr√°i: c√¢u h·ªèi -->
            <div class="col-md-8">
                <div class=" exercises-container">
                    <div id="exerciseCarousel" class="carousel slide" data-ride="carousel" data-interval="false">
                        <div class="carousel-inner">
                            <% exercise.questions.forEach((question, index) => { %>
                                <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                                    <div class="question-card p-3" data-correct-answer="<%= question.correctAnswer %>" data-explanation="<%= question.explanation %>" data-type="<%= question.type %>">
                                        <% if (question.type === 'multiple-choice') { %>
                                            <h4 class="question-title">Ch·ªçn ƒë√°p √°n ƒë√∫ng:</h4>
                                        <% } else if (question.type === 'fill-in-the-blank') { %>
                                            <h4 class="question-title">ƒêi·ªÅn v√†o ch·ªó tr·ªëng:</h4>
                                        <% } else if (question.type === 'translation') { %>
                                            <h4 class="question-title">D·ªãch c√¢u d∆∞·ªõi ƒë√¢y:</h4>
                                        <% } %>
                                        <h5 style="margin-top: 12px; line-height: 1.8"; id="ques-<%= index %>">
                                            <button class="speak-button btn-sm btn-outline mr-2" data-text="<%= question.question %>">üîä</button>
                                            <%= index + 1 %>. <%= question.question %>
                                        </h5> 
                                        <form id="question-form-<%= index %>" class="question-form mt-4">
                                            <% if (question.type === 'multiple-choice') { %>
                                                <div class="form-check">
                                                    <% question.options.forEach((option) => { %>
                                                        <input class="form-check-input" type="radio" name="answer" value="<%= option %>" id="option-<%= option %>-<%= index %>">
                                                        <label class="form-check-label" for="option-<%= option %>-<%= index %>">
                                                            <%= option %>
                                                        </label>
                                                    <% }) %>
                                                </div>
                                            <% } else if (question.type === 'fill-in-the-blank' || question.type === 'translation') { %>
                                                <textarea class="form-control question-input" name="answer" rows="4" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n"></textarea>
                                            <% } %>
                                            <div class="explanation mt-4" style="display: none;"></div>
                                            <button type="button" class="btn btn-success submit-answer mt-4" data-index="<%= index %>">Ki·ªÉm tra</button>
                                        </form>
            
                                        <hr>
                                        <div class="d-flex justify-content-between mt-3">
                                            <button class="btn btn-secondary prev-slide" type="button" data-slide="prev" <%= index === 0 ? 'disabled' : '' %>>Quay l·∫°i</button>
                                            <button class="btn btn-secondary next-slide ml-5" type="button" data-slide="next" <%= index === exercise.questions.length - 1 ? 'disabled' : '' %>>Ti·∫øp theo</button>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="sidebar">
                    <!-- Th·ªùi gian c√≤n l·∫°i ho·∫∑c ƒë√£ l√†m -->
                    <div class="time-remaining text-center">
                        <span id="timeLabel">Th·ªùi gian c√≤n l·∫°i:</span> <span id="time">20:00</span>
                    </div>
                    
                    <!-- N√∫t n·ªôp b√†i -->
                    <button id="submitQuizBtn" class="btn btn-primary submit-btn mb-4">N·ªôp b√†i</button>
                    
                    <!-- Danh s√°ch c√¢u h·ªèi -->
                    <h5 id="questionListTitle">Danh s√°ch c√¢u h·ªèi:</h5>
                    <div class="question-list mt-3">
                        <% exercise.questions.forEach((question, index) => { %>
                            <button class="question-number" id="question-btn-<%= index %>" data-index="<%= index %>"><%= index + 1 %></button>
                        <% }) %>
                    </div>
                    
                    <!-- Th·ªùi gian ƒë√£ l√†m v√† n√∫t xem l·ªãch s·ª≠ -->
                    <div id="completed-info" style="display: none; text-align: center;">
                        <h4>Th·ªùi gian ƒë√£ l√†m: <span id="completedTime"></span></h4>
                        <button class="btn btn-secondary mt-3" id="viewHistoryBtn">Xem l·ªãch s·ª≠</button>
                    </div>
                   <!-- Bootstrap Modal ƒë·ªÉ hi·ªÉn th·ªã l·ªãch s·ª≠ -->
                    <div class="modal fade" id="historyModal" tabindex="-1" role="dialog" aria-labelledby="historyModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                            <h5 class="modal-title" id="historyModalLabel">L·ªãch s·ª≠ c√°c c√¢u h·ªèi ƒë√£ l√†m</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            </div>
                            <div class="modal-body" id="historyContent">
                            <!-- N·ªôi dung l·ªãch s·ª≠ s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                            </div>
                            <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
                            </div>
                        </div>
                        </div>
                    </div>
  
                </div>
            </div>            
        </div>
    </div>
    <%- include('../partials/footer.ejs') %>
    <script>
        $(document).ready(function() {
            // ƒê·∫øm ng∆∞·ª£c th·ªùi gian l√†m b√†i
            let timeRemaining = 20 * 60; // Th·ªùi gian 60 ph√∫t (ƒë∆°n v·ªã: gi√¢y)
            let timer; // Bi·∫øn l∆∞u tr·ªØ timer ƒë·ªÉ c√≥ th·ªÉ d·ª´ng khi c·∫ßn
            // B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c th·ªùi gian khi trang t·∫£i
            function startTimer() {
                timer = setInterval(() => {
                    let minutes = Math.floor(timeRemaining / 60);
                    let seconds = timeRemaining % 60;
                    seconds = seconds < 10 ? '0' + seconds : seconds;
                    $('#time').text(minutes + ":" + seconds);
                    timeRemaining--;

                    if (timeRemaining < 0) {
                        clearInterval(timer);
                        alert("H·∫øt gi·ªù l√†m b√†i!");
                        $('#submitQuizBtn').click(); // T·ª± ƒë·ªông n·ªôp b√†i khi h·∫øt gi·ªù
                    }
                }, 1000);
            }
            
            startTimer();
            $('.speak-button').click(function() {
                const textToSpeak = $(this).data('text'); // L·∫•y n·ªôi dung t·ª´ thu·ªôc t√≠nh data-text
                speakText(textToSpeak);
            });

            function speakText(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'en-US'; // B·∫°n c√≥ th·ªÉ thay ƒë·ªïi ng√¥n ng·ªØ n·∫øu c·∫ßn
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Speech Synthesis.');
                }
            }
            $('.question-number').click(function() {
                const index = $(this).data('index');
                $('#exerciseCarousel').carousel(index);
            });
            
            let totalQuestions = $('.question-card').length;
            let answeredQuestions = 0;
            let correctAnswers = 0;
            
            $('.submit-answer').click(function() {
                const index = $(this).data('index');
                const questionCard = $(this).closest('.question-card');
                const questionType = questionCard.data('type');
                const correctAnswer = questionCard.data('correct-answer');
                const explanation = questionCard.data('explanation');

                let answer = '';

                if (questionType === 'multiple-choice') {
                    const selectedOption = $(`input[name="answer"]:checked`, `#question-form-${index}`);
                    if (selectedOption.length > 0) {
                        answer = selectedOption.val();
                    } else {
                        alert("Vui l√≤ng ch·ªçn m·ªôt ƒë√°p √°n.");
                        return;
                    }
                } else if (questionType === 'fill-in-the-blank' || questionType === 'translation') {
                    answer = $(`textarea[name="answer"]`, `#question-form-${index}`).val().trim();
                    if (answer === '') {
                        alert("Vui l√≤ng nh·∫≠p c√¢u tr·∫£ l·ªùi.");
                        return;
                    }
                }

                if (questionType === 'fill-in-the-blank' || questionType === 'translation') {
                    const answerElement = $(`textarea[name="answer"]`, `#question-form-${index}`);
                    answerElement.removeClass('correct-answer incorrect-answer');
                    if (answer === correctAnswer) {
                        answerElement.addClass('correct-answer');
                        questionCard.find('.explanation').html(`B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng.<br> Gi·∫£i th√≠ch: ${explanation}`).show();
                        $(`#question-btn-${index}`).css('background-color', '#28a745').css('color', 'white');
                        correctAnswers++;
                    } else {
                        answerElement.addClass('incorrect-answer');
                        questionCard.find('.explanation').html(`B·∫°n ƒë√£ tr·∫£ l·ªùi sai. ƒê√°p √°n ƒë√∫ng l√†: ${correctAnswer}. <br> Gi·∫£i th√≠ch: ${explanation}`).show();
                        $(`#question-btn-${index}`).css('background-color', '#dc3545').css('color', 'white');
                    }
                } else if (questionType === 'multiple-choice') {
                    if (answer === correctAnswer) {
                        $(`input[name="answer"]:checked + .form-check-label`, `#question-form-${index}`).addClass('correct-answer');
                        questionCard.find('.explanation').html(`B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng.<br> Gi·∫£i th√≠ch: ${explanation}`).show();
                        $(`#question-btn-${index}`).css('background-color', '#28a745').css('color', 'white');
                        correctAnswers++;
                    } else {
                        $(`input[name="answer"]:checked + .form-check-label`, `#question-form-${index}`).addClass('incorrect-answer');
                        $(`input[name="answer"][value="${correctAnswer}"] + .form-check-label`, `#question-form-${index}`).addClass('correct-answer');
                        questionCard.find('.explanation').html(`B·∫°n ƒë√£ tr·∫£ l·ªùi sai. ƒê√°p √°n ƒë√∫ng l√†: ${correctAnswer}.<br> Gi·∫£i th√≠ch: ${explanation}`).show();
                        $(`#question-btn-${index}`).css('background-color', '#dc3545').css('color', 'white');
                    }
                }
                $(`#question-form-${index} input, #question-form-${index} textarea`).prop('disabled', true).addClass('disabled');
                $(this).prop('disabled', true).addClass('disabled');
            });
            // Khi ng∆∞·ªùi d√πng b·∫•m n√∫t "N·ªôp b√†i"
            $('#submitQuizBtn').click(function() {
                if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?')) {
                    clearInterval(timer);
                    const timeTaken = 20 * 60 - timeRemaining;
                    const minutesTaken = Math.floor(timeTaken / 60);
                    const secondsTaken = timeTaken % 60;

                    $('#completedTime').text(`${minutesTaken}:${secondsTaken < 10 ? '0' + secondsTaken : secondsTaken}`);
                    $('.time-remaining, .question-list, #submitQuizBtn, #questionListTitle').hide();
                    $('#completed-info').show();
                    showResultScreen()
                }
            });
            function showResultScreen() {
                const percentageCorrect = (correctAnswers / totalQuestions) * 100;
                const iconSrc = percentageCorrect >= 50 ? '/static/images/iconhappy.png' : '/static/images/iconsad.png';
                const resultHtml = `
                    <div class="result-screen text-center">
                        <h2 class="text-center">K·∫øt qu·∫£ b√†i Luy·ªán t·∫≠p ng·ªØ ph√°p</h2>
                        <div class="row">
                            <div class="col-md-6 result-content">
                                <p>T·ªïng s·ªë c√¢u: <span class="result-number">${totalQuestions}</span></p>
                                <p>S·ªë c√¢u ƒë√∫ng: <span class="result-number correct">${correctAnswers}</span></p>
                                <p>S·ªë c√¢u sai: <span class="result-number incorrect">${totalQuestions - correctAnswers}</span></p>
                                <p>T·ª∑ l·ªá ƒë√∫ng: <span class="result-percentage">${percentageCorrect.toFixed(2)}%</span></p>
                            </div>
                            <div class="col-md-6 text-center result-icon">
                                <img src="${iconSrc}" alt="Icon k·∫øt qu·∫£">
                            </div>
                        </div>
                        <div class="d-flex flex-column align-items-center mt-3">
                            <button class="btn btn-danger" style="width: 200px; margin-bottom: 10px;" onclick="location.reload()">L√†m l·∫°i</button>
                            <button class="btn btn-secondary" style="width: 200px;" onclick="location.href='/grammar-exercise'">Tho√°t</button>
                        </div>
                    </div>
                `;

                $('.exercises-container').html(resultHtml);
            }
            $('#viewHistoryBtn').click(function() {
                let historyHtml = '';

                // Duy·ªát qua t·∫•t c·∫£ c√°c c√¢u h·ªèi v√† l·∫•y th√¥ng tin
                $('.question-card').each(function(index) {
                    const questionText = $(this).find('h5').text();
                    const correctAnswer = $(this).data('correct-answer');
                    const userAnswer = $(`#question-form-${index} input:checked`).val() || $(`#question-form-${index} textarea`).val();
                    const explanation = $(this).data('explanation');

                    // T·∫°o HTML cho l·ªãch s·ª≠ t·ª´ng c√¢u h·ªèi
                    historyHtml += `
                        <div class="history-item">
                            <h5>C√¢u ${index + 1}: ${questionText}</h5>
                            <p>ƒê√°p √°n c·ªßa b·∫°n: <strong>${userAnswer ? userAnswer : 'Ch∆∞a tr·∫£ l·ªùi'}</strong></p>
                            <p>ƒê√°p √°n ƒë√∫ng: <strong>${correctAnswer}</strong></p>
                            <p>Gi·∫£i th√≠ch: ${explanation}</p>
                            <hr>
                        </div>
                    `;
                });

                // Ch√®n n·ªôi dung v√†o modal
                $('#historyContent').html(historyHtml);

                // Hi·ªÉn th·ªã modal
                $('#historyModal').modal('show');
            });

            $('.next-slide').click(function() {
                $('#exerciseCarousel').carousel('next');
            });

            $('.prev-slide').click(function() {
                $('#exerciseCarousel').carousel('prev');
            });
            // TƒÉng c√¢u h·ªèi hi·ªán t·∫°i
            $('#exerciseCarousel').on('slid.bs.carousel', function() {
                const currentIndex = $('#exerciseCarousel .carousel-item.active').index();
                $('#current-question').text(currentIndex + 1);

                // V√¥ hi·ªáu h√≥a n√∫t "Quay l·∫°i" khi ·ªü c√¢u ƒë·∫ßu ti√™n
                $('.prev-slide').prop('disabled', currentIndex === 0);
                // V√¥ hi·ªáu h√≥a n√∫t "Ti·∫øp theo" khi ·ªü c√¢u cu·ªëi c√πng
                $('.next-slide').prop('disabled', currentIndex === $('.carousel-item').length - 1);
            });
        });
    </script>
    
    <script src="/static/js/jquery-1.12.1.min.js"></script>
    <script src="/static/js/popper.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/jquery.magnific-popup.js"></script>
    <script src="/static/js/swiper.min.js"></script>
    <script src="/static/js/masonry.pkgd.js"></script>
    <script src="/static/js/owl.carousel.min.js"></script>
    <script src="/static/js/jquery.nice-select.min.js"></script>
    <script src="/static/js/slick.min.js"></script>
    <script src="/static/js/jquery.counterup.min.js"></script>
    <script src="/static/js/waypoints.min.js"></script>
    <script src="/static/js/custom.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>   
</body>
</html>